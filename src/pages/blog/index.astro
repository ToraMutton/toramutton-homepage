---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import Parser from 'rss-parser';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

type UnifiedPost = {
  title: string;
  url: string;
  date: Date;
  image?: string | any;
  source: 'local' | 'note' | 'zenn';
  tags: string[];
};

const parser = new Parser({
    customFields: {
        item: [
            ['media:thumbnail', 'thumbnail'],
            ['category', 'categories', {keepArray: true}],
        ]
    }
});

// ÁîªÂÉèÂèñÂæóÂÆâÂÆöÁî®„Éò„É´„Éë„ÉºÈñ¢Êï∞
const getImageUrl = (item: any) => {
    if (item.thumbnail) {
        return typeof item.thumbnail === 'string' ? item.thumbnail : item.thumbnail.$?.url;
    }
    if (item.enclosure?.url) {
        return item.enclosure.url;
    }
    return item.content?.match(/src="(https:\/\/[^"]+)"/)?.[1];
}

// A. „É≠„Éº„Ç´„É´Ë®ò‰∫ã
const localPostsRaw = await getCollection('blog');
const localPosts: UnifiedPost[] = localPostsRaw.map((post) => ({
  title: post.data.title,
  url: `/blog/${post.id}/`,
  date: post.data.pubDate,
  image: post.data.heroImage, 
  source: 'local',
  tags: post.data.tags || [],
}));

// B. NoteË®ò‰∫ã
let notePosts: UnifiedPost[] = [];
try {
  const noteFeed = await parser.parseURL('https://note.com/toramutton/rss');
  notePosts = noteFeed.items.map((item: any) => {
    const rawTags = item.categories;
    const safeTags = (Array.isArray(rawTags) && rawTags.length > 0) ? rawTags : ['Note'];

    return {
        title: item.title || 'ÁÑ°È°å',
        url: item.link || '',
        date: new Date(item.pubDate || new Date()),
        image: getImageUrl(item),
        source: 'note',
        tags: safeTags,
    };
  });
} catch (e) {
  console.error("Note RSS fetch failed", e);
}

// C. ZennË®ò‰∫ã
let zennPosts: UnifiedPost[] = [];
try {
  const zennFeed = await parser.parseURL('https://zenn.dev/toramutton/feed');
  zennPosts = zennFeed.items.map((item: any) => ({
    title: item.title || 'ÁÑ°È°å',
    url: item.link || '',
    date: new Date(item.pubDate || new Date()),
    image: item.enclosure?.url || item.content?.match(/src="(https:\/\/[^"]+)"/)?.[1],
    source: 'zenn',
    tags: ['Zenn'],
  }));
} catch (e) {
  console.error("Zenn RSS fetch failed", e);
}

const allPosts = [...localPosts, ...notePosts, ...zennPosts].sort(
  (a, b) => b.date.valueOf() - a.date.valueOf()
);
---

<!doctype html>
<html lang="ja">
    <head>
        <BaseHead title={`${SITE_TITLE} | Blog`} description={SITE_DESCRIPTION} />
        <style>
        /* === ÂÖ®‰Ωì„ÅÆ„É¨„Ç§„Ç¢„Ç¶„Éà === */
        main {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 8rem 1.5rem 3rem;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
            list-style: none;
            padding: 0;
            margin: 0; /* ‰ΩôË®à„Å™„Éû„Éº„Ç∏„É≥ÂâäÈô§ */
        }

        /* üëá „É™„Çπ„Éà„Ç¢„Ç§„ÉÜ„É†Ôºà„Ç∞„É™„ÉÉ„Éâ„ÅÆÊû†ÔºâËá™‰Ωì„ÇÇ„Åó„Å£„Åã„ÇäÂ∫É„Åí„Çã */
        .grid-container li {
            width: 100%;
            display: flex; /* ‰∏≠Ë∫´Ôºà„Ç´„Éº„ÉâÔºâ„ÅÆÈ´ò„Åï„ÇíÊèÉ„Åà„Çã„Åü„ÇÅ„Å´flex */
        }

        @media (max-width: 600px) {
            main { padding: 6rem 1rem 2rem; }
            /* „Çπ„Éû„Éõ„ÅØ1Âàó */
            .grid-container { grid-template-columns: 1fr; gap: 1.5rem; }
        }

        /* === „Ç´„Éº„Éâ„Éá„Ç∂„Ç§„É≥ === */
        .card {
            width: 100%;
            height: 100%; /* È´ò„Åï„ÇíË¶™„Å´Âêà„Çè„Åõ„Çã */
            
            background: var(--surface);
            border: 1px solid var(--border-color, rgba(0,0,0,0.1));
            border-radius: 16px;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            display: flex;
            flex-direction: column;
            position: relative;
            text-decoration: none;
            color: var(--text-main);
            box-sizing: border-box;
        }
        
        :global(html.dark) .card {
            background: rgba(255,255,255,0.03);
            border-color: rgba(255,255,255,0.1);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
            border-color: var(--accent-blue, #7dd3fc);
        }

        /* === „Çµ„É†„Éç === */
        .thumbnail-container {
            width: 100%;
            aspect-ratio: 16 / 9;
            overflow: hidden;
            background: #333;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
            flex-shrink: 0; /* ÁîªÂÉè„Ç®„É™„Ç¢„ÅÆÊΩ∞„ÇåÈò≤Ê≠¢ */
        }

        .thumbnail-container img {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
            transition: transform 0.3s ease;
            z-index: 0;
        }
        
        .card:hover .thumbnail-container img {
            transform: scale(1.05);
        }

        .no-image {
            color: rgba(255,255,255,0.3);
            font-size: 0.9rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        /* „Éê„ÉÉ„Ç∏ */
        .badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 800;
            text-transform: uppercase;
            color: #fff;
            backdrop-filter: blur(4px);
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .badge.note { background: rgba(65, 201, 180, 0.9); }
        .badge.zenn { background: rgba(62, 168, 255, 0.9); }
        .badge.local { background: var(--accent-blue, #2563eb); color: #fff; }

        /* === Ë®ò‰∫ã„Ç≥„É≥„ÉÜ„É≥„ÉÑ === */
        .content {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            width: 100%;
            box-sizing: border-box;
        }

        .title {
            margin: 0;
            font-size: 1.1rem;
            line-height: 1.5;
            font-weight: 700;
            color: var(--text-main);
            overflow-wrap: break-word; 
        }

        .meta-info {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .tags-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .tag-item {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 99px;
            background: rgba(0,0,0,0.05);
            color: var(--text-muted);
            border: 1px solid rgba(0,0,0,0.1);
            font-family: 'JetBrains Mono', monospace;
            white-space: nowrap;
        }
        :global(html.dark) .tag-item {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.15);
        }

        .date {
            color: var(--text-muted);
            font-size: 0.8rem;
            font-family: 'JetBrains Mono', monospace;
            text-align: right;
        }
    </style>
    </head>
    <body>
        <Header />
        <main>
            <section>
                <ul class="grid-container">
                    {
                        allPosts.map((post) => (
                            <li style="display: flex;">
                                <a href={post.url} class="card" target={post.source !== 'local' ? "_blank" : "_self"} rel={post.source !== 'local' ? "noopener noreferrer" : ""}>
                                    <div class="thumbnail-container">
                                        <span class={`badge ${post.source}`}>{post.source}</span>
                                        {post.source === 'local' && typeof post.image === 'object' ? (
                                            <Image src={post.image} alt="" width={400} height={225} />
                                        ) : post.image && typeof post.image === 'string' ? (
                                            <img src={post.image} alt="" loading="lazy" />
                                        ) : (
                                            <div class="no-image">No Image</div>
                                        )}
                                    </div>
                                    <div class="content">
                                        <h4 class="title">{post.title}</h4>
                                        
                                        <div class="meta-info">
                                            {post.tags && post.tags.length > 0 && (
                                                <div class="tags-list">
                                                    {post.tags.slice(0, 3).map(tag => (
                                                        <span class="tag-item">#{tag}</span>
                                                    ))}
                                                    {post.tags.length > 3 && <span class="tag-item">...</span>}
                                                </div>
                                            )}

                                            <p class="date">
                                                {post.date.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' })}
                                            </p>
                                        </div>
                                    </div>
                                </a>
                            </li>
                        ))
                    }
                </ul>
            </section>
        </main>
        <Footer />
    </body>
</html>